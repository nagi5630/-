import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

st.set_page_config(page_title="æ ªä¾¡ãƒ‘ã‚¿ãƒ¼ãƒ³äºˆæ¸¬", layout="wide")
st.title("ğŸ“ˆ æ ªä¾¡ãƒãƒ£ãƒ¼ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æï¼†å°†æ¥äºˆæ¸¬")

# éŠ˜æŸ„å…¥åŠ›
code = st.text_input("éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆä¾‹: 7203.T for ãƒˆãƒ¨ã‚¿ã€AAPL for Appleï¼‰", "7203.T")

# -----------------------
# ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡ºé–¢æ•°
# -----------------------
def detect_patterns(prices):
    patterns = []
    if len(prices) < 60:
        return patterns

    last30 = prices[-30:]
    max_price = float(last30.max())
    min_price = float(last30.min())
    current = float(last30.iloc[-1])
    avg = float(last30.mean())

    # ãƒ€ãƒ–ãƒ«ãƒˆãƒƒãƒ—
    if abs(current - max_price) / max_price < 0.02:
        patterns.append({"name": "ãƒ€ãƒ–ãƒ«ãƒˆãƒƒãƒ—", "kind": "ä¸‹é™", "target": current * 0.95})

    # ãƒ€ãƒ–ãƒ«ãƒœãƒˆãƒ 
    elif abs(current - min_price) / min_price < 0.02:
        patterns.append({"name": "ãƒ€ãƒ–ãƒ«ãƒœãƒˆãƒ ", "kind": "ä¸Šæ˜‡", "target": current * 1.05})

    # ä¸Šæ˜‡ãƒ•ãƒ©ãƒƒã‚°
    elif current > avg * 1.05:
        patterns.append({"name": "ä¸Šæ˜‡ãƒ•ãƒ©ãƒƒã‚°", "kind": "ä¸Šæ˜‡", "target": current * 1.03})

    # ä¸‹é™ãƒ•ãƒ©ãƒƒã‚°
    elif current < avg * 0.95:
        patterns.append({"name": "ä¸‹é™ãƒ•ãƒ©ãƒƒã‚°", "kind": "ä¸‹é™", "target": current * 0.97})

    return patterns

# -----------------------
# å°†æ¥äºˆæ¸¬é–¢æ•°ï¼ˆç°¡æ˜“ãƒ¢ãƒ‡ãƒ«ï¼‰
# -----------------------
def forecast_future(data, periods=30):
    recent_trend = data['Close'].pct_change().dropna().mean()  # å¹³å‡ãƒªã‚¿ãƒ¼ãƒ³
    last_price = data['Close'].iloc[-1]
    forecast = [last_price]
    for _ in range(periods):
        forecast.append(forecast[-1] * (1 + recent_trend))
    return forecast

# -----------------------
# ãƒ¡ã‚¤ãƒ³å‡¦ç†
# -----------------------
if st.button("è§£æã™ã‚‹"):
    try:
        data = yf.download(code, period="1y", interval="1d")
        if data.empty:
            st.error("ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
            st.stop()

        close_prices = data["Close"]

        # ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º
        detected = detect_patterns(close_prices)

        # å°†æ¥äºˆæ¸¬
        future_prices = forecast_future(data)
        future_index = pd.date_range(start=data.index[-1], periods=len(future_prices), freq="D")

        # ã‚°ãƒ©ãƒ•æç”»
        fig, ax = plt.subplots(figsize=(12, 6))
        ax.plot(data.index, close_prices, label="éå»ã®æ ªä¾¡", color="blue")
        ax.plot(future_index, future_prices, label="å°†æ¥äºˆæ¸¬", linestyle="--", color="orange")

        # æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒ—ãƒ­ãƒƒãƒˆ
        if detected:
            for p in detected:
                ax.axhline(p["target"], color="red" if p["kind"] == "ä¸‹é™" else "green",
                           linestyle="--", linewidth=1)
                ax.text(data.index[-1], p["target"],
                        f"{p['name']} â†’ ç›®æ¨™: {p['target']:.2f}",
                        color="red" if p["kind"] == "ä¸‹é™" else "green")

        ax.set_title(f"{code} - æ ªä¾¡ã¨å°†æ¥äºˆæ¸¬")
        ax.legend()
        st.pyplot(fig)

        # ãƒ‘ã‚¿ãƒ¼ãƒ³æƒ…å ±è¡¨ç¤º
        st.subheader("ğŸ“Š æ¤œå‡ºã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³")
        if detected:
            for p in detected:
                st.write(f"âœ… **{p['name']}** ï¼ˆ{p['kind']}ãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰ â†’ ç›®æ¨™ä¾¡æ ¼: {p['target']:.2f}")
        else:
            st.write("è©²å½“ã™ã‚‹æ˜ç¢ºãªãƒ‘ã‚¿ãƒ¼ãƒ³ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚")

    except Exception as e:
        st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
