import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

st.set_page_config(page_title="æ ªä¾¡ã‚·ã‚°ãƒŠãƒ«åˆ¤å®šï¼‹æ¥­ç¸¾æƒ…å ±", layout="wide")
st.title("ğŸ“Š æ ªä¾¡ã‚·ã‚°ãƒŠãƒ«åˆ¤å®šï¼†è²¡å‹™æƒ…å ±ã‚¢ãƒ—ãƒª")

code = st.text_input("éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆä¾‹: 7203.T for ãƒˆãƒ¨ã‚¿ã€AAPL for Appleï¼‰", "7203.T")

def calc_rsi(series, period=14):
    delta = series.diff()
    gain = delta.where(delta > 0, 0)
    loss = -delta.where(delta < 0, 0)
    avg_gain = gain.rolling(period).mean()
    avg_loss = loss.rolling(period).mean()
    rs = avg_gain / avg_loss
    return 100 - (100 / (1 + rs))

def show_signal_explanation():
    st.markdown("""
    ### ã‚·ã‚°ãƒŠãƒ«ã®æ„å‘³ã¨æ ¹æ‹ 
    - **è²·ã„ã‚·ã‚°ãƒŠãƒ«**  
      - çŸ­æœŸç§»å‹•å¹³å‡ç·šï¼ˆSMA20ï¼‰ãŒä¸­æœŸç§»å‹•å¹³å‡ç·šï¼ˆSMA50ï¼‰ã‚’ä¸‹ã‹ã‚‰ä¸Šã«æŠœã‘ã‚‹ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¯ãƒ­ã‚¹ï¼‰  
      - RSIãŒ70æœªæº€ï¼ˆéç†±çŠ¶æ…‹ã§ãªã„ï¼‰  
      â†’ ã€Œä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰ã®å§‹ã¾ã‚Šã§ã€è²·ã„ãƒãƒ£ãƒ³ã‚¹ã€ã¨åˆ¤æ–­ã—ã¦ã„ã¾ã™ã€‚  
    - **å£²ã‚Šã‚·ã‚°ãƒŠãƒ«**  
      - çŸ­æœŸç§»å‹•å¹³å‡ç·šï¼ˆSMA20ï¼‰ãŒä¸­æœŸç§»å‹•å¹³å‡ç·šï¼ˆSMA50ï¼‰ã‚’ä¸Šã‹ã‚‰ä¸‹ã«æŠœã‘ã‚‹ï¼ˆãƒ‡ãƒƒãƒ‰ã‚¯ãƒ­ã‚¹ï¼‰  
      - ã¾ãŸã¯RSIãŒ70ä»¥ä¸Šï¼ˆè²·ã‚ã‚Œã™ãã®éç†±æ„Ÿï¼‰  
      â†’ ã€Œãƒˆãƒ¬ãƒ³ãƒ‰ã®è»¢æ›ã‚„åˆ©ç›Šç¢ºå®šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€ã¨è¦‹ã¦ã„ã¾ã™ã€‚  
    """)

def safe_single_value(v):
    """ã‚‚ã—vãŒSeries/DataFrameã‚„listãªã‚‰å˜ä¸€ã®å€¤ã«å¤‰æ›ã€ãã†ã§ãªã‘ã‚Œã°ãã®ã¾ã¾è¿”ã™"""
    if isinstance(v, pd.Series) or isinstance(v, pd.DataFrame):
        if v.empty:
            return None
        if isinstance(v, pd.DataFrame):
            return safe_single_value(v.iloc[0, 0])
        else:
            return safe_single_value(v.iloc[0])
    elif isinstance(v, (list, tuple)):
        if len(v) == 0:
            return None
        else:
            return safe_single_value(v[0])
    else:
        return v

def format_val(v):
    v = safe_single_value(v)
    if v is None:
        return "N/A"
    if isinstance(v, (int, float, np.float64, np.int64)):
        try:
            return f"{v:,.2f}"
        except Exception:
            return str(v)
    return str(v)

if st.button("è§£æã™ã‚‹"):
    try:
        data = yf.download(code, period="1y", interval="1d")
        if data.empty:
            st.error("ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
            st.stop()

        data["SMA20"] = data["Close"].rolling(20).mean()
        data["SMA50"] = data["Close"].rolling(50).mean()
        data["RSI"] = calc_rsi(data["Close"])

        buy_signals = (
            (data["SMA20"] > data["SMA50"]) &
            (data["SMA20"].shift(1) <= data["SMA50"].shift(1)) &
            (data["RSI"] < 70)
        )
        sell_signals = (
            (data["SMA20"] < data["SMA50"]) &
            (data["SMA20"].shift(1) >= data["SMA50"].shift(1))
        ) | (data["RSI"] > 70)

        fig, ax = plt.subplots(figsize=(12,6))
        ax.plot(data.index, data["Close"], label="Close", color="blue")
        ax.plot(data.index, data["SMA20"], label="SMA20", color="orange")
        ax.plot(data.index, data["SMA50"], label="SMA50", color="green")

        ax.scatter(data.index[buy_signals], data["Close"][buy_signals], marker="^", color="red", label="Buy")
        ax.scatter(data.index[sell_signals], data["Close"][sell_signals], marker="v", color="purple", label="Sell")

        ax.set_title(f"{code} - æ ªä¾¡ã‚·ã‚°ãƒŠãƒ«")
        ax.legend()
        st.pyplot(fig)

        st.subheader("ğŸ“ˆ è²·ã„ã‚·ã‚°ãƒŠãƒ«æ—¥")
        st.write(data.index[buy_signals].strftime("%Y-%m-%d").tolist())

        st.subheader("ğŸ“‰ å£²ã‚Šã‚·ã‚°ãƒŠãƒ«æ—¥")
        st.write(data.index[sell_signals].strftime("%Y-%m-%d").tolist())

        show_signal_explanation()

        st.subheader("ğŸ’¡ è²·ã„ãƒ»å£²ã‚Šä¾¡æ ¼ã®ç›®å®‰")

        recent_close = safe_single_value(data["Close"].dropna().iloc[-1])
        rolling_low = data["Low"].rolling(5).min().dropna()
        rolling_high = data["High"].rolling(5).max().dropna()

        recent_low = safe_single_value(rolling_low.iloc[-1]) if not rolling_low.empty else None
        recent_high = safe_single_value(rolling_high.iloc[-1]) if not rolling_high.empty else None

        st.write(f"ç¾åœ¨ã®çµ‚å€¤: {format_val(recent_close)} å††")

        if recent_low is not None:
            st.write(f"ç›´è¿‘5æ—¥é–“ã®å®‰å€¤: {format_val(recent_low)} å††")
        else:
            st.write("ç›´è¿‘5æ—¥é–“ã®å®‰å€¤ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚")

        if recent_high is not None:
            st.write(f"ç›´è¿‘5æ—¥é–“ã®é«˜å€¤: {format_val(recent_high)} å††")
        else:
            st.write("ç›´è¿‘5æ—¥é–“ã®é«˜å€¤ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚")

        st.markdown("""
        - **è²·ã„ç›®å®‰:** ç›´è¿‘5æ—¥é–“ã®å®‰å€¤ã‚’ä¸‹å›ã£ãŸã‚‰æ³¨ç›®ï¼ˆå‰²å®‰ã®å¯èƒ½æ€§ã‚ã‚Šï¼‰  
        - **å£²ã‚Šç›®å®‰:** ç›´è¿‘5æ—¥é–“ã®é«˜å€¤ã‚’è¶…ãˆãŸã‚‰åˆ©ç›Šç¢ºå®šã‚’æ¤œè¨  
        """)

        st.subheader("ğŸ¦ æ¥­ç¸¾ãƒ»è²¡å‹™æŒ‡æ¨™")

        ticker = yf.Ticker(code)
        info = ticker.info

        indicators = {
            "ç¾åœ¨æ ªä¾¡": info.get("currentPrice", "N/A"),
            "æ™‚ä¾¡ç·é¡": info.get("marketCap", "N/A"),
            "PERï¼ˆæ ªä¾¡åç›Šç‡ï¼‰": info.get("trailingPE", "N/A"),
            "PBRï¼ˆæ ªä¾¡ç´”è³‡ç”£å€ç‡ï¼‰": info.get("priceToBook", "N/A"),
            "ROEï¼ˆè‡ªå·±è³‡æœ¬åˆ©ç›Šç‡ï¼‰": info.get("returnOnEquity", "N/A"),
            "é…å½“åˆ©å›ã‚Š": info.get("dividendYield", "N/A"),
            "å£²ä¸Šé«˜": info.get("totalRevenue", "N/A"),
            "å–¶æ¥­åˆ©ç›Š": info.get("operatingIncome", "N/A"),
            "ç´”åˆ©ç›Š": info.get("netIncome", "N/A"),
            "ç™ºè¡Œæ¸ˆæ ªå¼æ•°": info.get("sharesOutstanding", "N/A"),
        }

        for key in indicators:
            indicators[key] = safe_single_value(indicators[key])

        df_indicators = pd.DataFrame.from_dict(indicators, orient="index", columns=["å€¤"])
        df_indicators["å€¤"] = df_indicators["å€¤"].apply(format_val)
        st.table(df_indicators)

    except Exception as e:
        st.error(f"ã‚¨ãƒ©ãƒ¼: {e}")
