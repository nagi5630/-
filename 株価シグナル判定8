# streamlit_future_trade_patterns.py
import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

st.set_page_config(page_title="æ ªä¾¡æœªæ¥ãƒ‘ã‚¿ãƒ¼ãƒ³äºˆæ¸¬ï¼†ãƒˆãƒ¬ãƒ¼ãƒ‰ç›®å®‰", layout="wide")
st.title("ğŸ“ˆ æ ªä¾¡æœªæ¥ãƒ‘ã‚¿ãƒ¼ãƒ³äºˆæ¸¬ï¼†ãƒˆãƒ¬ãƒ¼ãƒ‰ç›®å®‰ï¼ˆ15ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰")

# ------------------- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ -------------------
def safe_last_value(v):
    if isinstance(v, pd.DataFrame):
        if v.empty: return None
        return safe_last_value(v.iloc[-1,0])
    if isinstance(v, pd.Series):
        if v.empty: return None
        return safe_last_value(v.iloc[-1])
    if isinstance(v,(list,tuple,np.ndarray)):
        if len(v)==0: return None
        return safe_last_value(v[-1])
    return v

def format_price(v):
    v = safe_last_value(v)
    if v is None: return "N/A"
    try:
        return f"{float(v):,.2f}"
    except:
        return str(v)

def pct(a,b):
    try:
        a=float(a); b=float(b)
        if a==0: return 0.0
        return abs(a-b)/abs(a)*100.0
    except:
        return 0.0

def calc_sma(series, period):
    return series.rolling(period,min_periods=1).mean()

def calc_rsi(series, period=14):
    delta = series.diff()
    gain = delta.where(delta>0,0.0)
    loss = -delta.where(delta<0,0.0)
    avg_gain = gain.rolling(period,min_periods=1).mean()
    avg_loss = loss.rolling(period,min_periods=1).mean()
    rs = avg_gain/(avg_loss.replace(0,np.nan))
    rsi = 100-(100/(1+rs))
    return rsi.fillna(50.0)

# ------------------- æœªæ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‹ãƒˆãƒ¬ãƒ¼ãƒ‰ç›®å®‰ -------------------
def predict_future_trade_patterns(df, lookback=20):
    closes = df['Close'].values.astype(float)
    highs = df['High'].values.astype(float)
    lows = df['Low'].values.astype(float)
    recent = closes[-lookback:]
    recent_high = float(highs[-lookback:].max())
    recent_low = float(lows[-lookback:].min())
    last_close = float(closes[-1])
    patterns=[]

    # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ»åˆ©ç¢ºãƒ»æåˆ‡ã‚Šè¨ˆç®—é–¢æ•°
    def calc_trade(kind, target_price):
        if kind=='ä¸Šæ˜‡':
            entry = last_close * 0.995  # å°‘ã—æŠ¼ã—ç›®ã§è²·ã†
            take_profit = target_price
            stop_loss = last_close * 0.97
        else:
            entry = last_close * 1.005  # å°‘ã—æˆ»ã‚Šã§å£²ã‚‹
            take_profit = target_price
            stop_loss = last_close * 1.03
        return entry, take_profit, stop_loss

    # --- 15ãƒ‘ã‚¿ãƒ¼ãƒ³äºˆæ¸¬ ---
    # 1. ãƒ€ãƒ–ãƒ«ãƒˆãƒƒãƒ—ï¼2.ãƒ€ãƒ–ãƒ«ãƒœãƒˆãƒ 
    if len(recent)>=3:
        if float(recent[-2]) > float(recent[-3]) and float(recent[-2]) > float(recent[-1]):
            target = recent_low - (recent_high - recent_low)
            entry,tp,sl = calc_trade('ä¸‹è½', target)
            patterns.append({'name':'ãƒ€ãƒ–ãƒ«ãƒˆãƒƒãƒ—','kind':'ä¸‹è½','confidence':65,'target':target,'entry':entry,'sl':sl,'tp':tp})
        if float(recent[-2]) < float(recent[-3]) and float(recent[-2]) < float(recent[-1]):
            target = recent_high + (recent_high - recent_low)
            entry,tp,sl = calc_trade('ä¸Šæ˜‡', target)
            patterns.append({'name':'ãƒ€ãƒ–ãƒ«ãƒœãƒˆãƒ ','kind':'ä¸Šæ˜‡','confidence':65,'target':target,'entry':entry,'sl':sl,'tp':tp})

    # 3-4. ãƒˆãƒªãƒ—ãƒ«ãƒˆãƒƒãƒ—ï¼ãƒˆãƒªãƒ—ãƒ«ãƒœãƒˆãƒ 
    if len(recent)>=5:
        mid = float(recent[-3])
        if mid == max(recent[-5:]):
            target = recent_low - (mid - recent_low)
            entry,tp,sl = calc_trade('ä¸‹è½', target)
            patterns.append({'name':'ãƒˆãƒªãƒ—ãƒ«ãƒˆãƒƒãƒ—','kind':'ä¸‹è½','confidence':60,'target':target,'entry':entry,'sl':sl,'tp':tp})
        if mid == min(recent[-5:]):
            target = recent_high + (recent_high - mid)
            entry,tp,sl = calc_trade('ä¸Šæ˜‡', target)
            patterns.append({'name':'ãƒˆãƒªãƒ—ãƒ«ãƒœãƒˆãƒ ','kind':'ä¸Šæ˜‡','confidence':60,'target':target,'entry':entry,'sl':sl,'tp':tp})

    # 5-6. ãƒ˜ãƒƒãƒ‰ï¼†ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼ï¼é€†ãƒ˜ãƒƒãƒ‰ï¼†ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼
    if len(recent)>=7:
        mid = float(recent[-4])
        if mid == max(recent[-7:]):
            target = recent_low - (mid - recent_low)
            entry,tp,sl = calc_trade('ä¸‹è½', target)
            patterns.append({'name':'ãƒ˜ãƒƒãƒ‰ï¼†ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼','kind':'ä¸‹è½','confidence':60,'target':target,'entry':entry,'sl':sl,'tp':tp})
        if mid == min(recent[-7:]):
            target = recent_high + (recent_high - mid)
            entry,tp,sl = calc_trade('ä¸Šæ˜‡', target)
            patterns.append({'name':'é€†ãƒ˜ãƒƒãƒ‰ï¼†ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼','kind':'ä¸Šæ˜‡','confidence':60,'target':target,'entry':entry,'sl':sl,'tp':tp})

    # 7-8. ã‚½ãƒ¼ã‚µãƒ¼å‹ï¼ãƒ©ã‚¦ãƒ³ãƒ‰ãƒˆãƒƒãƒ—å‹
    if len(recent)>=10:
        mid = float(recent[-5])
        if mid == min(recent[-10:]):
            target = recent_high + (recent_high - mid)
            entry,tp,sl = calc_trade('ä¸Šæ˜‡', target)
            patterns.append({'name':'ã‚½ãƒ¼ã‚µãƒ¼å‹','kind':'ä¸Šæ˜‡','confidence':55,'target':target,'entry':entry,'sl':sl,'tp':tp})
        if mid == max(recent[-10:]):
            target = recent_low - (mid - recent_low)
            entry,tp,sl = calc_trade('ä¸‹è½', target)
            patterns.append({'name':'ãƒ©ã‚¦ãƒ³ãƒ‰ãƒˆãƒƒãƒ—å‹','kind':'ä¸‹è½','confidence':55,'target':target,'entry':entry,'sl':sl,'tp':tp})

    # 9-10. ãƒ•ãƒ©ãƒƒã‚°ï¼ãƒšãƒŠãƒ³ãƒˆ
    sma5_last = float(calc_sma(df['Close'],5).iloc[-1])
    if last_close > sma5_last:
        target = last_close * 1.03
        entry,tp,sl = calc_trade('ä¸Šæ˜‡', target)
        patterns.append({'name':'ãƒ•ãƒ©ãƒƒã‚°','kind':'ä¸Šæ˜‡','confidence':50,'target':target,'entry':entry,'sl':sl,'tp':tp})
        patterns.append({'name':'ãƒšãƒŠãƒ³ãƒˆ','kind':'ä¸Šæ˜‡','confidence':50,'target':target*0.98,'entry':entry,'sl':sl,'tp':tp*0.98})
    else:
        target = last_close * 0.97
        entry,tp,sl = calc_trade('ä¸‹è½', target)
        patterns.append({'name':'ãƒ•ãƒ©ãƒƒã‚°ä¸‹è½','kind':'ä¸‹è½','confidence':50,'target':target,'entry':entry,'sl':sl,'tp':tp})
        patterns.append({'name':'ãƒšãƒŠãƒ³ãƒˆä¸‹è½','kind':'ä¸‹è½','confidence':50,'target':target*0.98,'entry':entry,'sl':sl,'tp':tp*0.98})

    # 11-12. Vå­—ï¼é€†Vå­—
    if len(recent)>=3:
        if float(recent[-2]) < float(recent[-3]) and float(recent[-2]) < float(recent[-1]):
            target = last_close + (float(recent[-1])-float(recent[-2]))*1.5
            entry,tp,sl = calc_trade('ä¸Šæ˜‡', target)
            patterns.append({'name':'Vå­—å›å¾©','kind':'ä¸Šæ˜‡','confidence':55,'target':target,'entry':entry,'sl':sl,'tp':tp})
        if float(recent[-2]) > float(recent[-3]) and float(recent[-2]) > float(recent[-1]):
            target = last_close - (float(recent[-2])-float(recent[-1]))*1.5
            entry,tp,sl = calc_trade('ä¸‹è½', target)
            patterns.append({'name':'é€†Vå­—','kind':'ä¸‹è½','confidence':55,'target':target,'entry':entry,'sl':sl,'tp':tp})

    # 13-14. ãƒ¬ãƒ³ã‚¸ãƒ–ãƒ¬ã‚¤ã‚¯ä¸Šï¼ä¸‹
    if last_close > recent_high:
        target = last_close + (recent_high-recent_low)
        entry,tp,sl = calc_trade('ä¸Šæ˜‡', target)
        patterns.append({'name':'ãƒ¬ãƒ³ã‚¸ãƒ–ãƒ¬ã‚¤ã‚¯ä¸Š','kind':'ä¸Šæ˜‡','confidence':60,'target':target,'entry':entry,'sl':sl,'tp':tp})
    if last_close < recent_low:
        target = last_close - (recent_high-recent_low)
        entry,tp,sl = calc_trade('ä¸‹è½', target)
        patterns.append({'name':'ãƒ¬ãƒ³ã‚¸ãƒ–ãƒ¬ã‚¤ã‚¯ä¸‹','kind':'ä¸‹è½','confidence':60,'target':target,'entry':entry,'sl':sl,'tp':tp})

    # 15. ãƒ¬ãƒ³ã‚¸åç™º
    mid_range = (recent_high+recent_low)/2
    if abs(last_close-mid_range)/mid_range < 0.02:
        target = mid_range + (recent_high-mid_range)
        entry,tp,sl = calc_trade('ä¸Šæ˜‡', target)
        patterns.append({'name':'ãƒ¬ãƒ³ã‚¸åç™º','kind':'ä¸Šæ˜‡','confidence':50,'target':target,'entry':entry,'sl':sl,'tp':tp})

    return patterns

# ------------------- Streamlit UI -------------------
st.markdown("éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨æœªæ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ãƒˆãƒ¬ãƒ¼ãƒ‰ç›®å®‰ï¼ˆã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ»åˆ©ç¢ºãƒ»æåˆ‡ã‚Šï¼‰ã‚’äºˆæ¸¬ã—ã¾ã™ã€‚")

symbol = st.text_input("éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰", "AAPL")
run = st.button("æœªæ¥äºˆæ¸¬")

if run:
    try:
        df=yf.download(symbol,period="1y",interval="1d",progress=False).dropna()
        if df.empty:
            st.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")
            st.stop()

        df['SMA20']=calc_sma(df['Close'],20)
        df['SMA50']=calc_sma(df['Close'],50)
        df['RSI']=calc_rsi(df['Close'])

        patterns=predict_future_trade_patterns(df)
        if not patterns:
            st.warning("ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ")
        else:
            patterns.sort(key=lambda x:x.get('confidence',50),reverse=True)
            top_patterns=patterns[:5]
            rows=[]
            for p in top_patterns:
                rows.append({
                    'ãƒ‘ã‚¿ãƒ¼ãƒ³':p['name'],
                    'ç¨®åˆ¥':p['kind'],
                    'ä¿¡é ¼åº¦(%)':p['confidence'],
                    'ã‚¨ãƒ³ãƒˆãƒªãƒ¼':format_price(p['entry']),
                    'åˆ©ç¢ºç›®å®‰':format_price(p['tp']),
                    'æåˆ‡ã‚Š':format_price(p['sl'])
                })
            st.subheader("ğŸ” ä¿¡é ¼åº¦ä¸Šä½ãƒ‘ã‚¿ãƒ¼ãƒ³")
            st.table(pd.DataFrame(rows))

        # æç”»
        fig,ax=plt.subplots(figsize=(14,6))
        ax.plot(df.index,df['Close'],label='Close',color='tab:blue')
        ax.plot(df.index,df['SMA20'],label='SMA20',color='tab:orange')
        ax.plot(df.index,df['SMA50'],label='SMA50',color='tab:green')
        ax.grid(alpha=0.2)
        ax.set_title(f"{symbol} - éå»1å¹´ã®ãƒãƒ£ãƒ¼ãƒˆ")

        # æœªæ¥ãƒ‘ã‚¿ãƒ¼ãƒ³çŸ¢å°æç”»
        for p in top_patterns:
            if p['kind']=='ä¸Šæ˜‡':
                ax.annotate(f"â†‘{p['name']}({p['confidence']}%)",
                            xy=(df.index[-1], float(df['Close'].iloc[-1])),
                            xytext=(df.index[-1], float(p['tp'])),
                            arrowprops=dict(facecolor='green', shrink=0.05))
            else:
                ax.annotate(f"â†“{p['name']}({p['confidence']}%)",
                            xy=(df.index[-1], float(df['Close'].iloc[-1])),
                            xytext=(df.index[-1], float(p['tp'])),
                            arrowprops=dict(facecolor='red', shrink=0.05))

        ax.legend()
        st.pyplot(fig)

    except Exception as e:
        st.error(f"ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: {e}")
