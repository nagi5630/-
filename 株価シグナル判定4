# streamlit_future_pattern.py
import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

st.set_page_config(page_title="æœªæ¥äºˆæ¸¬ãƒãƒ£ãƒ¼ãƒˆ", layout="wide")
st.title("ğŸ“ˆ æ ªä¾¡æœªæ¥äºˆæ¸¬ãƒãƒ£ãƒ¼ãƒˆï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ™ãƒ¼ã‚¹ï¼‰")

# ---------- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ----------
def safe_last_value(v):
    if isinstance(v, pd.DataFrame):
        if v.empty:
            return None
        return safe_last_value(v.iloc[-1, 0])
    if isinstance(v, pd.Series):
        if v.empty:
            return None
        return safe_last_value(v.iloc[-1])
    if isinstance(v, (list, tuple, np.ndarray)):
        if len(v) == 0:
            return None
        return safe_last_value(v[-1])
    return v

def format_price(v):
    v = safe_last_value(v)
    if v is None:
        return "N/A"
    try:
        return f"{float(v):,.2f}"
    except Exception:
        return str(v)

def pct(a, b):
    try:
        a = float(a)
        b = float(b)
        if a == 0:
            return 0.0
        return abs(a - b) / abs(a) * 100.0
    except Exception:
        return 0.0

# ---------- ç°¡æ˜“ãƒ‘ã‚¿ãƒ¼ãƒ³äºˆæ¸¬ ----------
def predict_future_from_pattern(df):
    """
    éå»ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰æœªæ¥ã®å€¤ã‚’äºˆæ¸¬
    """
    closes = df['Close'].values
    last_close = closes[-1]
    patterns = []

    # ãƒ€ãƒ–ãƒ«ãƒœãƒˆãƒ äºˆæ¸¬
    min_price = closes[-20:].min()
    if last_close <= min_price * 1.02:
        target = last_close + (last_close - min_price)
        patterns.append({
            'name': 'ãƒ€ãƒ–ãƒ«ãƒœãƒˆãƒ äºˆæ¸¬',
            'kind': 'ä¸Šæ˜‡äºˆæ¸¬',
            'entry': last_close,
            'target': target,
            'stop': min_price * 0.99
        })

    # ãƒ€ãƒ–ãƒ«ãƒˆãƒƒãƒ—äºˆæ¸¬
    max_price = closes[-20:].max()
    if last_close >= max_price * 0.98:
        target = last_close - (max_price - last_close)
        patterns.append({
            'name': 'ãƒ€ãƒ–ãƒ«ãƒˆãƒƒãƒ—äºˆæ¸¬',
            'kind': 'ä¸‹è½äºˆæ¸¬',
            'entry': last_close,
            'target': target,
            'stop': max_price * 1.01
        })

    # ã‚½ãƒ¼ã‚µãƒ¼ãƒœãƒˆãƒ /ãƒˆãƒƒãƒ—ã®å˜ç´”äºˆæ¸¬
    if closes[-10:].mean() < closes[-20:-10].mean():
        # ä¸‹ã‹ã‚‰ä¸Šæ˜‡ã™ã‚‹å¯èƒ½æ€§
        target = last_close * 1.05
        patterns.append({
            'name': 'ã‚½ãƒ¼ã‚µãƒ¼ãƒœãƒˆãƒ äºˆæ¸¬',
            'kind': 'ä¸Šæ˜‡äºˆæ¸¬',
            'entry': last_close,
            'target': target,
            'stop': last_close * 0.98
        })
    elif closes[-10:].mean() > closes[-20:-10].mean():
        target = last_close * 0.95
        patterns.append({
            'name': 'ã‚½ãƒ¼ã‚µãƒ¼ãƒˆãƒƒãƒ—äºˆæ¸¬',
            'kind': 'ä¸‹è½äºˆæ¸¬',
            'entry': last_close,
            'target': target,
            'stop': last_close * 1.02
        })
    return patterns

# ---------- Streamlit UI ----------
col1, col2 = st.columns([1,3])
with col1:
    symbol = st.text_input("éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ (ä¾‹: AAPL, 7203.T)", "AAPL")
    period_select = st.selectbox("å–å¾—æœŸé–“", ["6mo","1y","2y"], index=1)
    run = st.button("è§£æãƒ»æœªæ¥äºˆæ¸¬ã™ã‚‹")

with col2:
    placeholder = st.empty()

if run:
    try:
        df = yf.download(symbol, period=period_select, interval="1d", progress=False)
        if df is None or df.empty:
            st.error("ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“")
            st.stop()
        df = df.dropna()
        if len(df) < 30:
            st.error("ãƒ‡ãƒ¼ã‚¿ä¸è¶³")
            st.stop()

        patterns = predict_future_from_pattern(df)

        # ãƒãƒ£ãƒ¼ãƒˆæç”»
        fig, ax = plt.subplots(figsize=(14,6))
        ax.plot(df.index, df['Close'], color='gray', label='éå»Close')

        for p in patterns:
            last_idx = df.index[-1]
            future_idx = pd.date_range(last_idx, periods=5, freq='B')[1:]  # 5å–¶æ¥­æ—¥äºˆæ¸¬
            entry = p['entry']
            target = p['target']
            stop = p['stop']
            ax.plot([last_idx]+list(future_idx), [entry]+[target]*len(future_idx), color='green', linestyle='--', label=p['name'])
            ax.axhline(stop, color='red', linestyle=':', label='æåˆ‡ãƒ©ã‚¤ãƒ³')

        ax.set_title(f"{symbol} æœªæ¥äºˆæ¸¬ãƒãƒ£ãƒ¼ãƒˆ")
        ax.set_xlabel("Date")
        ax.set_ylabel("Price")
        ax.grid(alpha=0.3)
        ax.legend(fontsize='small')
        st.pyplot(fig)

        if patterns:
            st.subheader("ğŸ”® äºˆæ¸¬ãƒ‘ã‚¿ãƒ¼ãƒ³")
            df_pat = pd.DataFrame(patterns)
            df_pat['entry'] = df_pat['entry'].apply(format_price)
            df_pat['target'] = df_pat['target'].apply(format_price)
            df_pat['stop'] = df_pat['stop'].apply(format_price)
            st.table(df_pat)
        else:
            st.info("ç¾åœ¨ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰æœªæ¥äºˆæ¸¬ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚")

    except Exception as e:
        st.error(f"ã‚¨ãƒ©ãƒ¼: {e}")

