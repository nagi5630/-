import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

st.set_page_config(page_title="æ ªä¾¡ã‚·ã‚°ãƒŠãƒ«åˆ¤å®š", layout="wide")
st.title("ğŸ“Š æ ªä¾¡ã‚·ã‚°ãƒŠãƒ«åˆ¤å®šã‚¢ãƒ—ãƒªï¼ˆyfinanceç‰ˆï¼‰")

code = st.text_input("éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆä¾‹: 7203.T for ãƒˆãƒ¨ã‚¿ã€AAPL for Appleï¼‰", "7203.T")

def calc_rsi(series, period=14):
    delta = series.diff()
    gain = delta.where(delta > 0, 0)
    loss = -delta.where(delta < 0, 0)
    avg_gain = gain.rolling(period).mean()
    avg_loss = loss.rolling(period).mean()
    rs = avg_gain / avg_loss
    return 100 - (100 / (1 + rs))

if st.button("è§£æã™ã‚‹"):
    try:
        data = yf.download(code, period="1y", interval="1d")

        if data.empty:
            st.error("ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        else:
            data["SMA20"] = data["Close"].rolling(20).mean()
            data["SMA50"] = data["Close"].rolling(50).mean()
            data["RSI"] = calc_rsi(data["Close"])

            buy_signals = (
                (data["SMA20"] > data["SMA50"])
                & (data["SMA20"].shift(1) <= data["SMA50"].shift(1))
                & (data["RSI"] < 70)
            )
            sell_signals = (
                (data["SMA20"] < data["SMA50"])
                & (data["SMA20"].shift(1) >= data["SMA50"].shift(1))
            ) | (data["RSI"] > 70)

            fig, ax = plt.subplots(figsize=(12, 6))
            ax.plot(data.index, data["Close"], label="Close", color="blue")
            ax.plot(data.index, data["SMA20"], label="SMA20", color="orange")
            ax.plot(data.index, data["SMA50"], label="SMA50", color="green")

            ax.scatter(data.index[buy_signals], data["Close"][buy_signals], marker="^", color="red", label="Buy")
            ax.scatter(data.index[sell_signals], data["Close"][sell_signals], marker="v", color="purple", label="Sell")

            ax.set_title(f"{code} - æ ªä¾¡ã‚·ã‚°ãƒŠãƒ«")
            ax.legend()
            st.pyplot(fig)

            st.subheader("ğŸ“ˆ è²·ã„ã‚·ã‚°ãƒŠãƒ«æ—¥")
            st.write(data.index[buy_signals].strftime("%Y-%m-%d").tolist())

            st.subheader("ğŸ“‰ å£²ã‚Šã‚·ã‚°ãƒŠãƒ«æ—¥")
            st.write(data.index[sell_signals].strftime("%Y-%m-%d").tolist())

    except Exception as e:
        st.error(f"ã‚¨ãƒ©ãƒ¼: {e}")
